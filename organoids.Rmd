---
title: "Organoids"
output: 
  bookdown::html_document2:
    code_folding: hide
---

```{r setup, message = FALSE, warning=FALSE, results="hide"}
library(tidyverse)
knitr::opts_chunk$set(cache = TRUE)
devtools::load_all()
library(brms)
library(readxl)
library(lubridate)
theme_set(cowplot::theme_cowplot())
options(mc.cores = parallel::detectCores(), brms.backend = "cmdstanr")
rstan::rstan_options(auto_write = TRUE)
cache_dir <- here::here("local_temp_data")
if(!dir.exists(cache_dir)) {
  dir.create(cache_dir)
}

```

```{r}
primary_concentration_labels <- c("0.128", "0.32", "0.8")
```


# Read and check the data 

```{r}
raw_data <- read_raw_data() 
```



```{r}
# Check data integrity

missing_timepoints <-  raw_data %>% group_by(patient, date, well) %>% summarise(count = n(), .groups = "drop") %>% filter(count != 7)
if(nrow(missing_timepoints) > 0) {
  print(missing_timepoints)
  stop("Missing timepoints")
}

missing_duplicates <- raw_data %>% group_by(patient, origin, type, date, fsk_concentration, filename) %>% summarise(count = n(), .groups = "drop") %>% 
  filter(count != 14,
# For some, this is indeed the case                                                                                                         
      filename != "21-CF 20200918.xlsx" & type != "Symkevi" & fsk_concentration != 0.02048
      )

if(nrow(missing_duplicates) > 0) {
  print(missing_duplicates)
  stop("Missing duplicates")
}


missing_concentrations <- raw_data %>% select(patient, origin, type, date, p,  fsk_concentration) %>% distinct() %>% 
  group_by(patient, origin, type, date, p) %>%
  summarise(count = n(), .groups = "drop") %>% filter((origin != "patient" & count != 4) | (origin == "patient"  & count != 8))

if(nrow(missing_concentrations) > 0) {
  print(missing_concentrations)
  stop("Missing concentrations")
}
```

```{r}
raw_data <- raw_data %>% compute_derived_quantitites() %>% remove_few_replicates

auc <- raw_data_to_auc(raw_data)

```

The data are checked to match the hand-derived summaries.

```{r}
# Check matching to original summaries

auc_date_avg <- auc %>%
  group_by(patient, date, fsk_concentration, fsk_label, type,filename) %>% 
  summarise(date_avg_auc = mean(auc), .groups = "drop")

auc_pat_avg <- auc_date_avg %>%   
  group_by(patient, fsk_concentration, type) %>% 
  summarise(pat_avg_auc = mean(date_avg_auc), .groups = "drop")

summary_manual_raw <- read_excel("DATA/results_summary 20201130_new.xlsx", range = "A1:K18") 
summary_manual <- summary_manual_raw %>% 
  pivot_longer(cols = c(starts_with("Symkevi"), starts_with("Kaftrio")), names_to = c("type", "fsk_concentration"), values_to = "pat_avg_auc", names_sep = " ") %>%
  mutate(fsk_concentration = gsub(",", ".", fsk_concentration, fixed = TRUE))

matched <- auc_pat_avg %>% mutate(fsk_concentration = as.character(round(fsk_concentration, 3))) %>%
  mutate(fsk_concentration = if_else(fsk_concentration == "0.008", "0", fsk_concentration)) %>%
  inner_join(summary_manual, by = c("patient" = "ID", "type", "fsk_concentration"))

if(nrow(matched) != nrow(summary_manual)) {
  print(summary_manual %>% anti_join(matched, by = c("ID" = "patient", "fsk_concentration", "type")) )
  stop("Not all matched")
}

mismatched <- matched %>% filter(abs(pat_avg_auc.x - pat_avg_auc.y) > 1e-5) %>%
  filter(patient != "10-CF")
warning("Ignoring mismatch in 10-CF")

if(nrow(mismatched) > 0) {
  print(mismatched)
  stop("Mismatched")
}
```

# Is the control condition flat?

```{r}
raw_data %>% 
  filter(type == "FskOnly") %>%
  ggplot(aes(x = time, y = area, group = interaction(patient, date, well))) + 
  geom_line(alpha = 0.3) +
  facet_wrap( ~ fsk_label)

raw_data %>% 
  filter(type == "FskOnly") %>%
  ggplot(aes(x = time, y = swell, group = interaction(patient, date, well))) + 
  geom_line(alpha = 0.3) +
  facet_wrap( ~ fsk_label)


auc %>% 
  filter(type == "FskOnly") %>%
  ggplot(aes(x = fsk_label, y = auc)) +
  geom_hline(yintercept = 0, color = "blue") + 
  geom_jitter(alpha = 0.3, width = 0.3, height = 0)

auc_date_avg %>%
  filter(type == "FskOnly") %>%
  ggplot(aes(x = fsk_label, y = date_avg_auc, group = interaction(patient, date))) +
  geom_hline(yintercept = 0, color = "blue") +
  geom_line(alpha = 0.3) 
```



# Is there a difference at t = 0?

Diff in area at baseline

```{r}
raw_data %>% 
  filter(time == 0) %>%
  ggplot(aes(x = type, y = area)) + 
  geom_boxplot(outlier.shape = NA) +
  geom_jitter(alpha = 0.3, width = 0.2, height = 0)  + ggtitle("Area at t = 0")
```

```{r}
t.test(raw_data %>% filter(time == 0, type == "Symkevi") %>% pull(area), raw_data %>% filter(time == 0, type == "Kaftrio") %>% pull(area))

t.test(raw_data %>% filter(time == 0, type == "FskOnly") %>% pull(area), raw_data %>% filter(time == 0, type == "Symkevi") %>% pull(area))

```

There seems to be a _very small_ systematic difference in area between all treatments at time 0.

TODO: lepe diff at 0


# Effect of treatments on organoid growth

## Plots, descriptive statistics

Throughout this notebook, we use several measures: 

- **area**: the raw area from the data
- **swell**: percentage change from area at time 0 (i.e. -100 means decrease to zero, +100 means the area increased to twice the area at time 0)
- **AUC**: area under the curve, i.e. the integral of the swell curve (can be negative)

### Plots at the individual well resolution

```{r areaallsep, fig.cap="Raw area by time, treatment and forskolin concentration. Each line is a single well."}
raw_data %>% ggplot(aes(x = time, y = area, group = interaction(patient, date, well))) + 
  geom_line(alpha = 0.3) +
  facet_grid(type ~ fsk_label)
```

```{r areaalloverlay, fig.cap="Raw area by time, treatment and forskolin concentration, overlaid. Each line is a single well." }

type_color_scale <-   scale_color_brewer(type = "qual", guide = guide_legend(override.aes = list(alpha = 1)))

plot_area <- function(raw_data, alpha = 0.3) {
  raw_data %>% 
    ggplot(aes(x = time, y = area, color = type, group = interaction(patient, date, well))) + 
    geom_line(alpha = alpha) +
    type_color_scale +
    facet_wrap( ~ fsk_label)
}

plot_area(raw_data)
```

```{r swellallsep, fig.cap="Swell by time, treatment and forskolin concentration. Each line is a single well."}
raw_data %>% 
  ggplot(aes(x = time, y = swell, group = interaction(patient, date, well))) + 
  geom_line(alpha = 0.3) +
  facet_grid(type ~ fsk_label)

```
```{r swellalloverlay, fig.cap = "Swell by time, treatment and forskolin concentration, overlaid. Each line is a single well."}


plot_swell <- function(raw_data, alpha = 0.3) {
  raw_data %>% 
    ggplot(aes(x = time, y = swell, color = type, group = interaction(patient, date, well))) + 
    geom_line(alpha = alpha) +
    type_color_scale +
    facet_wrap( ~ fsk_label)
}

plot_swell(raw_data)

#ggsave(here::here("local_temp_data", "swell_all.png"), plot_swell(raw_data))

```


### Plots at the experiment/well plate level

```{r}
auc_date_avg %>%
  ggplot(aes(x = fsk_label, y = date_avg_auc, group = interaction(patient, date))) +
  geom_line(alpha = 0.3) +
  facet_wrap(~type) + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5))

```


```{r}

auc_date_avg %>%
  ggplot(aes(x = fsk_label, y = date_avg_auc, color = type, group = interaction(patient, date, type))) +
  geom_line(alpha = 0.5) +
  type_color_scale

```




## Modelling

### Frequentist models

We test two linear model variants: the _AUC_ model focuses on the AUC metric, which is modelled as normally distributed with the full interaction of the forskolin level and drug as predictors. In the _area_ model we model the logarithm of area of the organoids explicitly, assuming normal distribution and treating the log of the area at time 0 and full interaction of time, forskolin level and drug as predictors (i.e. we assume that the area at time 0 is multiplied by a number that is specific for each drug and time step but does not differ between patients and replicates).

We use the `TukeyHSD` method to correct for multiple comparisons.

```{r}
fit_lm_auc <- lm(auc ~ fsk_label * type, data = auc %>% filter(type != "FskOnly"))
fit_lm_auc
summary(fit_lm_auc)
hsd_res_auc <- TukeyHSD(aov(fit_lm_auc))
interesting_res_auc <- hsd_res_auc$`fsk_label:type`[paste0(levels(auc$fsk_label), ":Kaftrio-",levels(auc$fsk_label),":Symkevi"),]
interesting_res_auc

interesting_res_auc_primary <- hsd_res_auc$`fsk_label:type`[paste0(primary_concentration_labels, ":Kaftrio-",primary_concentration_labels,":Symkevi"),]


```

For the AUC model we see noticeable difference between Symkevi and Kaftrio for all forskolin concentration (all p < 0.001), and the difference is large - for all of the primary concentrations (`r paste0(primary_concentration_labels, collapse = ", ")`) the 95% CI exclude absolute difference in AUC < `r round(min(interesting_res_auc_primary[,"lwr"]))`.


```{r}
raw_data_to_fit <- raw_data %>% 
  filter(type != "FskOnly", time > 0) %>%
  mutate(is_kaftrio = factor(type == "Kaftrio"),
         log_area = log(area),
         log_base_area = log(base_area),
         time_f = factor(time))


fit_lm_area_base <- lm(log_area ~ log_base_area + type*time_f*fsk_label, data = raw_data_to_fit)
summary(fit_lm_area_base)

hsd_res_area <- TukeyHSD(aov(fit_lm_area_base), which = c("type:time_f:fsk_label"))
interesting_cases_area <- crossing(fsk = levels(auc$fsk_label), time = levels(raw_data_to_fit$time_f)) %>%
  mutate(name = paste0("Kaftrio:", time,":", fsk, "-Symkevi:", time, ":", fsk)) %>% 
  pull(name)
interesting_res_area <-  hsd_res_area$`type:time_f:fsk_label`[interesting_cases_area,]
interesting_res_area[interesting_res_area[,"p adj"] < 1e-3,]
interesting_res_area[interesting_res_area[,"p adj"] >= 1e-3,]
```

Let us note that the coefficient for the are at time 0 (`log_base_area`) is fitted as almost exactly 1, which is a bit of support for this model being a good fit for the data.

```{r}
interesting_cases_area_primary_60 <- data.frame(fsk = primary_concentration_labels, time = 60) %>%
  mutate(name = paste0("Kaftrio:", time,":", fsk, "-Symkevi:", time, ":", fsk)) %>% 
  pull(name)
interesting_res_area_primary_60 <-  hsd_res_area$`type:time_f:fsk_label`[interesting_cases_area_primary_60,]

min_lwr_60 <- min(interesting_res_area_primary_60[,"lwr"])
#max_diff_40 <- max(interesting_res_area[grepl("\\:[4-6]0\\:", rownames(interesting_res_area)),"upr"])

#round((exp(min_lwr_60) - 1) * 100)
#round((exp(max_diff_40) - 1) * 100)

```



For the area model we see statistically significant relative increase in area for Kaftrio over Symkevi when forskolin concentration is larger than 0.128 or when time > 10 minutes (all p < 0.001) at 60 minutes and for the primary concentrations (`r paste0(primary_concentration_labels, collapse = ", ")`) the model rules out less than `r round((exp(min_lwr_60) - 1) * 100)`% increase in area with Kaftrio over Symkevi for all forskolin concentrations. 


### Bayesian mixed-effects models

Similarly to the frequentist models, we test an area and an AUC model. For the are model, we add a varying intercept and varying effect of Kaftrio per patient (i.e. both the absolute growth and the effect of Kaftrio is allowed to vary between patients) and a varying intercept per each time series (i.e. the growth in each well is allowed to vary a bit).

```{r}
raw_data_area_fit <- raw_data %>% 
  filter(fsk_label %in% primary_concentration_labels, 
         type != "FskOnly", time > 0) %>%
  mutate(is_kaftrio = factor(type == "Kaftrio"),
         log_base_area = log(base_area),
         log_area = log(area),
         filename_well = paste0(filename, "__", well),
         time_f = factor(time))

if(!identical(as.character(unique(raw_data_area_fit$fsk_label)), primary_concentration_labels)) {
  stop("Bad filter")
}

f_area_vs_base_1 <-log_area ~ log_base_area + fsk_label * type*time_f + 
  (1 + type || patient) + (1 || filename_well) 
fit_area_vs_base_1 <- brm_with_cache(f_area_vs_base_1, data = raw_data_area_fit, family = gaussian(), iter = 2000, cache_file = paste0(cache_dir, "/fit_area_vs_base_1.rds"))

#brms::parnames(f_area_vs_base_one_1)

fit_area_vs_base_1
```

We can then summarise the posterior credible intervals for difference between Kaftrio and Symkevi across forskolin concentrations and times - all intervals are very far from zero, indicating strong support for Kaftrio being beneficial.

```{r}
hypotheses_area <- crossing(fsk_label = primary_concentration_labels, time = 10*(2:6)) %>%
  mutate(hypothesis_string = paste0("typeKaftrio ", 
                             if_else(fsk_label == primary_concentration_labels[1], 
                                     "", paste0(" + fsk_label",fsk_label,":typeKaftrio + fsk_label",fsk_label,":typeKaftrio:time_f", time)), " + typeKaftrio:time_f", time, " > 0"))

hypotheses_area_res <- brms::hypothesis(fit_area_vs_base_1, hypotheses_area$hypothesis_string, alpha = 0.025)

hypotheses_area_res$hypothesis %>% 
  cbind(hypotheses_area) %>% 
  ggplot(aes(x = time, y = Estimate, ymin = CI.Lower, ymax = CI.Upper)) +
  geom_linerange() + geom_point() + geom_hline(yintercept = 0, color = "blue") + facet_wrap(~fsk_label)
```
We also fit an AUC model where we also add varying intercept and effect for patients and a varying intercept for experiment (well plate).

```{r, results="hide"}
auc_data_fit <- auc %>%
  filter(fsk_label %in% primary_concentration_labels, 
         type != "FskOnly")

fit_auc1 <- brm_with_cache(auc ~ fsk_label * type + 
  (1 + type || patient) + (1 || filename) , data = auc_data_fit, family = "gaussian", cache_file = paste0(cache_dir, "/fit_auc1.rds"))
```
We do some posterior predictive checks to test the fit of the model.

```{r}
pp_check(fit_auc1, "stat_grouped", stat = "sd", group = "fsk_label", nsamples = 4000)
pp_check(fit_auc1, "stat_grouped", stat = "sd", group = "type", nsamples = 4000)
```

We see the model has problems fitting the standard deviation, so we test another, more flexible model where the standard deviation is allowed to vary per treatment and forskolin concentration.

```{r, results="hide"}
fit_auc2 <- brm_with_cache(bf(auc ~ fsk_label * type + 
  (1 + type || patient) + (1 || filename), sigma ~ type + fsk_label), data = auc_data_fit, family = "gaussian", cache_file = paste0(cache_dir, "/fit_auc2.rds"))
fit_auc2
```


```{r}
pp_check(fit_auc2, "stat_grouped", stat = "sd", group = "fsk_label", nsamples = 4000)
pp_check(fit_auc2, "stat_grouped", stat = "sd", group = "type", nsamples = 4000)
```


We can then summarise the posterior credible intervals for difference between Kaftrio and Symkevi across forskolin concentrations  - all intervals are very far from zero, indicating strong support for Kaftrio being beneficial.

```{r}
hypotheses_auc <- data.frame(fsk_label = primary_concentration_labels) %>%
  mutate(hypothesis_string = paste0("typeKaftrio ", 
                             if_else(fsk_label == primary_concentration_labels[1], 
                                     "", paste0(" + fsk_label",fsk_label,":typeKaftrio")), " > 0"))

hypotheses_auc_res <- brms::hypothesis(fit_auc2, hypotheses_auc$hypothesis_string, alpha = 0.025)

hypotheses_auc_res$hypothesis %>% 
  cbind(hypotheses_auc) %>% 
  ggplot(aes(x = fsk_label, y = Estimate, ymin = CI.Lower, ymax = CI.Upper)) +
  geom_linerange() + geom_point() + geom_hline(yintercept = 0, color = "blue") 
```


# Do some patients show worsening/no improvement on Kaftrio?

First, let us plot the swell of patients that have at least one AUC value higher for Symkevi than Kaftrio:

```{r}
reversed_patients <- auc_date_avg %>% 
  filter(type != "FskOnly") %>%
  pivot_wider(names_from = "type",values_from = "date_avg_auc") %>%
  filter(Symkevi > Kaftrio) %>%
  pull(patient) %>% unique()

for(r_p in reversed_patients) {
  print(plot_swell(raw_data %>% filter(patient == r_p), alpha = 1) + ggtitle(r_p))
}
```

We will then fit a linear model separately for each of those patients (focusing on the concentrations `r paste0(primary_concentration_labels, collapse = ", ")` and times > 20 only. We then report the union of all confidence interval across all time-steps, the lowest p-value for all Kaftrio-Symkevi differences and the number of differences that are significant after TukeyHSD procedure.  

```{r}
rev_results_list <- list()
for(pt in reversed_patients) {
  raw_data_to_fit_reversed <- raw_data_to_fit %>% filter(patient == pt, fsk_label %in% primary_concentration_labels, time > 20)
  fit_lm_area_base_reversed_pt <- lm(log_area ~ log_base_area + type*time_f*fsk_label, data = raw_data_to_fit_reversed)
  
  hsd_res_area_pt <- suppressWarnings(
    TukeyHSD(aov(fit_lm_area_base_reversed_pt), which = c("type:time_f:fsk_label")))
  
  interesting_cases_area_pt <- crossing(fsk = primary_concentration_labels, time = as.character(unique(raw_data_to_fit_reversed$time_f))) %>%
    mutate(name = paste0("Kaftrio:", time,":", fsk, "-Symkevi:", time, ":", fsk)) %>% 
    pull(name)
  interesting_res_area_pt <-  hsd_res_area_pt$`type:time_f:fsk_label`[interesting_cases_area_pt,]
  
  rev_results_list[[length(rev_results_list) + 1]] <- data.frame(patient = pt, 
                                                                 union_ci_low = min(interesting_res_area_pt[,"lwr"]),
                                                                 union_ci_high = max(interesting_res_area_pt[,"upr"]), 
                                                                 min_p_adjusted = min(interesting_res_area_pt[,"p adj"]), 
                                                                 num_siginificant = sum(interesting_res_area_pt[,"p adj"] < 0.05 & interesting_res_area_pt[,"diff"] > 0))
  #print(interesting_res_area_pt[interesting_res_area_pt[,"p adj"] < 0.05,])
}

rev_results <- do.call(rbind, rev_results_list)
rev_results %>% knitr::kable(caption = paste0("Results for the potentially reversed patients. The num_significant are out of ", nrow(interesting_res_area_pt), " total tests."))
```

We see that the strictest bounds are for the 58-CF patient, where we can rule out differences larger than roughly ±0.25 on the log scale, i.e. 1.3 times increase or decrease. Data for the 20-CF patient are also somewhat consistent with no increase in Kaftrio over Symkevi, for the other candidates we have quite good suppport for improvement in Kaftrio. 
(Note: the mixed model from the previous section predicts some improvement for Kaftrio over Symkevi for all patients)
